<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Hospital Command Center</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #1e293b; /* slate-800 */
      color: #e2e8f0; /* slate-200 */
      background-image: linear-gradient(rgba(30, 41, 59, 0.95), rgba(30, 41, 59, 0.95)), 
                        radial-gradient(circle at 25% 25%, #334155 2%, transparent 100%),
                        radial-gradient(circle at 75% 75%, #334155 2%, transparent 100%);
      background-size: 100% 100%, 50px 50px, 50px 50px;
    }
    .map-room-rect {
      fill: #334155;
      stroke: #475569;
      stroke-width: 2px;
      transition: all 0.2s ease-in-out;
    }
    .map-room-group:hover .map-room-rect { fill: #475569; }
    .map-room-group.active .map-room-rect {
      fill: #475569;
      stroke: #0ea5e9;
    }
    @keyframes pulse-glow {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.8; }
    }
    @keyframes flash-glow {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .pulse-glow { animation: pulse-glow 2.5s infinite ease-in-out; }
    .flash-glow { animation: flash-glow 1.2s infinite ease-in-out; }

    .stat-card {
        background: #334155;
        border: 1px solid #475569;
    }
    .tooltip {
        position: absolute;
        display: none;
        background-color: #0f172a;
        color: #e2e8f0;
        padding: 8px 12px;
        border-radius: 6px;
        border: 1px solid #475569;
        font-size: 12px;
        pointer-events: none;
        z-index: 10;
        white-space: nowrap;
    }
    /* Custom scrollbar for alert feed */
    #alert-feed::-webkit-scrollbar {
        width: 6px;
    }
    #alert-feed::-webkit-scrollbar-track {
        background: transparent;
    }
    #alert-feed::-webkit-scrollbar-thumb {
        background: #475569; /* slate-600 */
        border-radius: 3px;
    }
    #alert-feed::-webkit-scrollbar-thumb:hover {
        background: #64748b; /* slate-500 */
    }
  </style>
</head>
<body class="antialiased">

<div class="w-full h-screen flex flex-col p-4 md:p-6">
  <!-- Header with Global Stats -->
  <header class="w-full flex-none">
    <div class="flex justify-between items-center mb-4">
        <div>
            <h1 class="text-3xl font-bold text-slate-100 tracking-tight">Hospital Command Center</h1>
            <div class="flex items-center space-x-2">
                <div id="system-status-light" class="w-3 h-3 rounded-full bg-green-500 animate-pulse"></div>
                <p id="system-status-text" class="text-slate-400 text-sm">All Systems Operational</p>
            </div>
        </div>
        <div class="flex items-center space-x-4">
             <!-- UPDATED: Consistent rounded-xl, shadow-lg, and padding -->
             <div class="stat-card p-4 rounded-xl shadow-lg text-center w-48">
                <p id="live-clock" class="text-2xl font-bold text-slate-100">00:00:00</p>
                <p class="text-xs font-semibold text-slate-400">System Time</p>
            </div>
            <div class="stat-card p-4 rounded-xl shadow-lg text-center w-36">
                <p class="text-sm font-semibold text-slate-400">High-Risk Rooms</p>
                <p id="high-risk-rooms-count" class="text-2xl font-bold text-rose-500">0</p>
            </div>
            <div class="stat-card p-4 rounded-xl shadow-lg text-center w-36">
                <p class="text-sm font-semibold text-slate-400">Med-Risk Rooms</p>
                <p id="medium-risk-rooms-count" class="text-2xl font-bold text-amber-500">0</p>
            </div>
        </div>
    </div>
  </header>

  <!-- Main Content Area -->
  <!-- UPDATED: Increased gap from gap-6 to gap-8 -->
  <main class="w-full flex-grow grid grid-cols-1 lg:grid-cols-3 gap-8 min-h-0">
    <!-- Map Section -->
    <section class="lg:col-span-2 bg-[#0f172a]/70 backdrop-blur-sm p-4 rounded-xl shadow-lg flex items-center justify-center border border-slate-700 relative">
        <svg id="hospital-map" viewBox="0 0 800 600" class="w-full h-full">
            <defs>
                <g id="icon-heart-rate"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 13.5l4.125-4.125m0 0L12 14.25l4.125-4.125M7.875 9.375l4.125 4.125M12 3v18" /></g>
                <g id="icon-general-ward"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 9.75h4.875a2.625 2.625 0 010 5.25H12M8.25 9.75L6.75 12l1.5 2.25m0 0l1.5-2.25L12 12m9-7.243V21.75l-3.75-1.5-3.75 1.5-3.75-1.5-3.75 1.5V4.757c0-1.108.806-2.057 1.907-2.185a48.507 48.507 0 0111.186 0c1.1.128 1.907 1.077 1.907 2.185z" /></g>
                <g id="icon-droplet"><path stroke-linecap="round" stroke-linejoin="round" d="M15.362 5.214A8.252 8.252 0 0112 21 8.25 8.25 0 016.038 7.048 8.287 8.287 0 009 9.6a8.983 8.983 0 013.362-1.44m0 0c-3.037-1.07-5.775-1.07-8.812 0a8.963 8.963 0 00-1.312 4.962 8.963 8.963 0 001.312 4.962c3.037 1.07 5.775 1.07 8.812 0a8.963 8.963 0 001.312-4.962 8.963 8.963 0 00-1.312-4.962z" /></g>
                <g id="icon-syringe"><path stroke-linecap="round" stroke-linejoin="round" d="M9.75 3.104v5.714a2.25 2.25 0 01-.21 1.042l-3.352 4.93-3.535.243a.75.75 0 00-.65.945l.91 4.061a.75.75 0 00.945.65l4.06-1.092a.75.75 0 00.65-.945l.244-3.535 4.93-3.352a2.25 2.25 0 011.042-.21H21a.75.75 0 00.75-.75V6.354a.75.75 0 00-.75-.75H12.354a.75.75 0 00-.495.18l-2.109 1.687z" /></g>
                <g id="icon-pacemaker"><path stroke-linecap="round" stroke-linejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12z" /><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.75l1.5 3.75 3.75.75-2.25 3 1.5 3.75-3.75-1.5-3.75 1.5 1.5-3.75-2.25-3 3.75-.75L12 6.75z" /></g>
                <g id="icon-shield"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75l3 3m0 0l3-3m-3 3v-7.5M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></g>
                <g id="icon-wrench"><path stroke-linecap="round" stroke-linejoin="round" d="M11.42 15.17L17.25 21A2.652 2.652 0 0021 17.25l-5.877-5.877M11.42 15.17l2.471-2.471a.563.563 0 01.801 0l3.743 3.743a.563.563 0 010 .801l-2.471 2.471M11.42 15.17l-4.636-4.636a1.125 1.125 0 010-1.591l3.744-3.744a1.125 1.125 0 011.59 0l4.636 4.636" /></g>
            </defs>
            <g id="room-icu" class="map-room-group cursor-pointer"><rect class="map-room-rect" x="50" y="50" width="300" height="180" rx="10"/><use href="#icon-heart-rate" x="185" y="110" width="30" height="30" class="stroke-slate-400" stroke-width="1.5" fill="none"/><text x="200" y="170" text-anchor="middle" class="fill-slate-300 font-semibold text-2xl">ICU</text></g>
            <g id="room-general-ward" class="map-room-group cursor-pointer"><rect class="map-room-rect" x="50" y="250" width="300" height="300" rx="10"/><use href="#icon-general-ward" x="185" y="375" width="30" height="30" class="stroke-slate-400" stroke-width="1.5" fill="none"/><text x="200" y="435" text-anchor="middle" class="fill-slate-300 font-semibold text-2xl">General Ward</text></g>
            <g id="room-endocrinology" class="map-room-group cursor-pointer"><rect class="map-room-rect" x="370" y="50" width="380" height="180" rx="10"/><use href="#icon-droplet" x="545" y="110" width="30" height="30" class="stroke-slate-400" stroke-width="1.5" fill="none"/><text x="560" y="170" text-anchor="middle" class="fill-slate-300 font-semibold text-2xl">Endocrinology</text></g>
            <g id="room-diabetes-care" class="map-room-group cursor-pointer"><rect class="map-room-rect" x="370" y="250" width="180" height="300" rx="10"/><use href="#icon-syringe" x="445" y="375" width="30" height="30" class="stroke-slate-400" stroke-width="1.5" fill="none"/><text x="460" y="435" text-anchor="middle" class="fill-slate-300 font-semibold text-2xl">Diabetes Care</text></g>
            <g id="room-cardiology" class="map-room-group cursor-pointer"><rect class="map-room-rect" x="570" y="250" width="180" height="300" rx="10"/><use href="#icon-pacemaker" x="645" y="375" width="30" height="30" class="stroke-slate-400" stroke-width="1.5" fill="none"/><text x="660" y="435" text-anchor="middle" class="fill-slate-300 font-semibold text-2xl">Cardiology</text></g>
        </svg>
        <div id="map-tooltip" class="tooltip"></div>
    </section>

    <!-- Device Info Section -->
    <aside class="lg:col-span-1 bg-[#0f172a]/70 backdrop-blur-sm p-4 rounded-xl shadow-lg flex flex-col border border-slate-700">
      <h2 id="device-panel-title" class="text-xl font-bold mb-4 border-b border-slate-700 pb-3 text-slate-200 flex-none">Select a Room</h2>
      <div id="device-list" class="flex-grow overflow-y-auto space-y-3 pr-2 min-h-0">
        <p class="text-slate-400 text-center mt-10">Device information will appear here.</p>
      </div>
       <div class="flex-none mt-4 pt-4 border-t border-slate-700">
        <h3 class="text-lg font-bold text-slate-200 mb-2">Live Alert Feed</h3>
        <div id="alert-feed" class="text-xs space-y-2 h-24 overflow-y-auto pr-1">
            <p class="text-slate-500">No critical alerts.</p>
        </div>
      </div>
    </aside>
  </main>
</div>

<script>
    const API_BASE_URL = 'http://127.0.0.1:9000';

    const hospitalLayout = {
        "room-icu": { name: "ICU", devices: ["heart_rate_sensor_02"] },
        "room-general-ward": { name: "General Ward", devices: ["blood_pressure_monitor_01"] },
        "room-endocrinology": { name: "Endocrinology", devices: ["glucose_monitor_01"] },
        "room-diabetes-care": { name: "Diabetes Care", devices: ["insulin_pump_01"] },
        "room-cardiology": { name: "Cardiology", devices: ["pacemaker_01"] }
    };

    const allDeviceTypes = {
        "heart_rate_sensor_02": "heart_rate_sensor",
        "blood_pressure_monitor_01": "blood_pressure_monitor",
        "glucose_monitor_01": "glucose_monitor",
        "insulin_pump_01": "insulin_pump",
        "pacemaker_01": "pacemaker"
    };
    
    let deviceScores = {};
    let deviceHistory = {};
    let liveAlerts = [];
    let activeRoomId = null;

    const dom = {
        map: document.getElementById('hospital-map'),
        tooltip: document.getElementById('map-tooltip'),
        devicePanelTitle: document.getElementById('device-panel-title'),
        deviceList: document.getElementById('device-list'),
        alertFeed: document.getElementById('alert-feed'),
        highRiskRoomsCount: document.getElementById('high-risk-rooms-count'),
        mediumRiskRoomsCount: document.getElementById('medium-risk-rooms-count'),
        liveClock: document.getElementById('live-clock')
    };

    function getRiskInfo(score) {
        if (score > 40) return { color: 'red', textClass: 'text-rose-400', borderClass: 'border-l-[6px] border-rose-500', animationClass: 'flash-glow', tag: 'High Risk' };
        if (score > 20) return { color: 'yellow', textClass: 'text-amber-400', borderClass: 'border-l-[6px] border-amber-500', animationClass: 'pulse-glow', tag: 'Medium Risk' };
        return { color: 'green', textClass: 'text-emerald-400', borderClass: 'border-l-[6px] border-emerald-500', animationClass: 'pulse-glow', tag: 'Operational' };
    }

    function timeAgo(timestamp) {
        const now = new Date();
        const seconds = Math.floor((now - timestamp) / 1000);
        if (seconds < 10) return "just now";
        if (seconds < 60) return `${seconds}s ago`;
        const minutes = Math.floor(seconds / 60);
        if (minutes < 60) return `${minutes}m ago`;
        const hours = Math.floor(minutes / 60);
        return `${hours}h ago`;
    }

    function createSparkline(history, color) {
        if (!history || history.length < 2) return '';
        const w = 80, h = 20;
        const max = Math.max(...history), min = Math.min(...history);
        const range = max - min === 0 ? 1 : max - min;
        const points = history.map((d, i) => `${(i/(history.length-1))*w},${h-((d-min)/range)*h}`).join(' ');
        const stroke = { red: '#f43f5e', yellow: '#f59e0b', green: '#22c55e' }[color];
        return `<svg viewBox="0 0 ${w} ${h}" class="w-20 h-5"><polyline fill="none" stroke="${stroke}" stroke-width="2" points="${points}"/></svg>`;
    }

    function updateUI() {
        let highRiskRooms = 0, mediumRiskRooms = 0;
        for (const roomId in hospitalLayout) {
            const roomEl = document.getElementById(roomId);
            const roomRect = roomEl.querySelector('.map-room-rect');
            if (!roomEl) continue;
            let highestRisk = 0;
            hospitalLayout[roomId].devices.forEach(id => {
                const score = deviceScores[id]?.risk_score || 0;
                if (score > highestRisk) highestRisk = score;
            });
            const risk = getRiskInfo(highestRisk);
            
            const fillColor = {red: '#f43f5e', yellow: '#f59e0b', green: '#166534'}[risk.color];
            roomRect.style.fill = fillColor;

            roomEl.classList.remove('pulse-glow', 'flash-glow');
            roomEl.classList.add(risk.animationClass);
            
            if (risk.color === 'red') highRiskRooms++;
            if (risk.color === 'yellow') mediumRiskRooms++;
        }
        dom.highRiskRoomsCount.textContent = highRiskRooms;
        dom.mediumRiskRoomsCount.textContent = mediumRiskRooms;
        renderDeviceListForActiveRoom();
        renderAlertFeed();
    }
    
    function renderDeviceListForActiveRoom() {
        if (!activeRoomId) {
            dom.devicePanelTitle.textContent = 'Select a Room';
            dom.deviceList.innerHTML = '<p class="text-slate-400 text-center mt-10">Device information will appear here.</p>';
            return;
        }
        const room = hospitalLayout[activeRoomId];
        dom.devicePanelTitle.textContent = room.name;
        dom.deviceList.innerHTML = '';
        room.devices.forEach(deviceId => {
            const data = deviceScores[deviceId];
            if (!data) return;
            const risk = getRiskInfo(data.risk_score);
            const card = document.createElement('div');
            // UPDATED: Added shadow-md to device cards
            card.className = `p-3 rounded-lg shadow-md ${risk.borderClass} bg-slate-800/50`;
            card.innerHTML = `
                <div class="flex justify-between items-start">
                    <div>
                        <p class="font-bold text-slate-200">${deviceId.replace(/_/g, ' ')}</p>
                        <p class="text-xs ${risk.textClass} font-semibold">${risk.tag}</p>
                    </div>
                    <div class="text-3xl font-extrabold text-slate-200">${data.risk_score}</div>
                </div>
                <div class="mt-2 flex justify-between items-end">
                    <div class="text-xs text-slate-400 space-y-1">
                        <p class="flex items-center"><svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><use href="#icon-shield"/></svg>Patch: <span class="${data.patch_status === 'unpatched' ? 'text-amber-400' : 'text-slate-300'} ml-1">${data.patch_status}</span></p>
                        <p class="flex items-center"><svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><use href="#icon-wrench"/></svg>Maint: <span class="${data.maintenance_days > 180 ? 'text-amber-400' : 'text-slate-300'} ml-1">${data.maintenance_days} days</span></p>
                    </div>
                    ${createSparkline(deviceHistory[deviceId], risk.color)}
                </div>`;
            dom.deviceList.appendChild(card);
        });
    }

    function renderAlertFeed() {
        if (liveAlerts.length === 0) {
            dom.alertFeed.innerHTML = '<p class="text-slate-500">No critical alerts.</p>';
            return;
        }
        dom.alertFeed.innerHTML = liveAlerts.map(alert => 
            `<div class="flex items-start"><span class="text-rose-400 mr-2 mt-0.5">●</span><div><span class="font-semibold">${alert.deviceId}</span><span class="text-slate-400"> reported high risk.</span><div class="text-slate-500">${timeAgo(alert.time)}</div></div></div>`
        ).join('');
    }
    
    async function fetchAllDeviceScores() {
        const promises = Object.entries(allDeviceTypes).map(async ([deviceId, deviceType]) => {
            const normalcyChance = 0.6;
            const isNormal = Math.random() < normalcyChance;
            let payload;
            if (isNormal) {
                payload = { device_id: deviceId, device_type: deviceType, pkt_sec: Math.random() * 20, bytes_sec: Math.random() * 1000, dest_count: Math.floor(Math.random() * 3), avg_payload: Math.random() * 128, patch_status: 'patched', maintenance_days: Math.floor(Math.random() * 90) };
            } else {
                payload = { device_id: deviceId, device_type: deviceType, pkt_sec: Math.random() * 500, bytes_sec: Math.random() * 10000, dest_count: Math.floor(Math.random() * 20), avg_payload: Math.random() * 1024, patch_status: Math.random() > 0.8 ? 'unpatched' : 'patched', maintenance_days: Math.floor(Math.random() * 365) };
            }
            try {
                const res = await fetch(`${API_BASE_URL}/ml/score`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!res.ok) return;
                const data = await res.json();
                
                const oldScoreData = deviceScores[deviceId];
                const newScore = data.risk_score;
                
                deviceScores[deviceId] = { ...data, patch_status: payload.patch_status, maintenance_days: payload.maintenance_days };
                
                if (!deviceHistory[deviceId]) deviceHistory[deviceId] = [];
                deviceHistory[deviceId].push(data.risk_score);
                if (deviceHistory[deviceId].length > 15) deviceHistory[deviceId].shift();

                if (getRiskInfo(newScore).color === 'red' && getRiskInfo(oldScoreData?.risk_score || 0).color !== 'red') {
                    liveAlerts.unshift({ deviceId, time: new Date() });
                    if (liveAlerts.length > 10) liveAlerts.pop();
                }
            } catch (error) { console.error(`API Error for ${deviceId}:`, error); }
        });
        await Promise.all(promises);
        updateUI();
    }
    
    function updateClock() {
        dom.liveClock.textContent = new Date().toLocaleTimeString('en-US');
    }

    dom.map.addEventListener('click', (e) => {
        const roomGroup = e.target.closest('.map-room-group');
        if (!roomGroup) return;
        document.querySelectorAll('.map-room-group.active').forEach(el => el.classList.remove('active'));
        roomGroup.classList.add('active');
        activeRoomId = roomGroup.id;
        renderDeviceListForActiveRoom();
    });

    dom.map.addEventListener('mousemove', (e) => {
        const roomGroup = e.target.closest('.map-room-group');
        if (roomGroup) {
            const room = hospitalLayout[roomGroup.id];
            let highestRisk = 0;
            room.devices.forEach(id => {
                const score = deviceScores[id]?.risk_score || 0;
                if (score > highestRisk) highestRisk = score;
            });
            const risk = getRiskInfo(highestRisk);
            dom.tooltip.style.display = 'block';
            dom.tooltip.style.left = `${e.clientX + 15}px`;
            dom.tooltip.style.top = `${e.clientY}px`;
            dom.tooltip.innerHTML = `<strong>${room.name}</strong><br>Status: <span class="${risk.textClass}">${risk.tag}</span>`;
        } else {
            dom.tooltip.style.display = 'none';
        }
    });

    window.addEventListener('load', () => {
        fetchAllDeviceScores();
        setInterval(fetchAllDeviceScores, 2500);
        updateClock();
        setInterval(updateClock, 1000);
        setInterval(renderAlertFeed, 5000); 
    });
</script>
</body>
</html>

