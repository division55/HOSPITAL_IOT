<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Analytics - Hospital Command Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1e293b; /* slate-800 */
            color: #e2e8f0; /* slate-200 */
        }
        .glass-panel {
            background: rgba(49, 65, 85, 0.7);
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            border: 1px solid #475569;
        }
        #room-list::-webkit-scrollbar { width: 6px; }
        #room-list::-webkit-scrollbar-track { background: transparent; }
        #room-list::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        #room-list::-webkit-scrollbar-thumb:hover { background: #64748b; }
    </style>
</head>
<body class="antialiased">

<div class="w-full h-screen flex flex-col p-4 md:p-6">
    <!-- Header -->
    <header class="w-full flex-none">
        <div class="flex justify-between items-center mb-4">
            <div>
                <h1 class="text-3xl font-bold text-slate-100 tracking-tight">Real-Time Analytics</h1>
                <p class="text-slate-400">Live Device Risk Scores by Room</p>
            </div>
            <div class="flex items-center space-x-4">
                <div class="glass-panel p-4 rounded-xl shadow-lg text-center w-48">
                    <p id="avg-risk-score" class="text-2xl font-bold text-slate-100">0</p>
                    <p class="text-xs font-semibold text-slate-400">Avg. Risk Score</p>
                </div>
                <a href="index1.html" class="bg-slate-700 hover:bg-teal-500 text-slate-200 hover:text-white font-bold py-2 px-4 rounded-lg transition-colors">
                    Back to Command Center
                </a>
            </div>
        </div>
    </header>

    <!-- Room List -->
    <main id="room-list" class="w-full flex-grow space-y-4 overflow-y-auto p-2 pr-4">
        <!-- Room cards will be injected here by JavaScript -->
    </main>
</div>

<script>
    // --- AUTH GUARD ---
    if (sessionStorage.getItem('isLoggedIn') !== 'true') {
        window.location.href = 'login.html';
    }

    const API_BASE_URL = 'http://127.0.0.1:9000';

    const hospitalLayout = {
        "room-icu": { name: "ICU", devices: ["heart_rate_sensor_02"] },
        "room-general-ward": { name: "General Ward", devices: ["blood_pressure_monitor_01"] },
        "room-endocrinology": { name: "Endocrinology", devices: ["glucose_monitor_01"] },
        "room-diabetes-care": { name: "Diabetes Care", devices: ["insulin_pump_01"] },
        "room-cardiology": { name: "Cardiology", devices: ["pacemaker_01"] }
    };

    const allDeviceTypes = {
        "heart_rate_sensor_02": "heart_rate_sensor",
        "blood_pressure_monitor_01": "blood_pressure_monitor",
        "glucose_monitor_01": "glucose_monitor",
        "insulin_pump_01": "insulin_pump",
        "pacemaker_01": "pacemaker"
    };
    
    let deviceScores = {};
    let deviceHistory = {};

    const dom = {
        roomList: document.getElementById('room-list'),
        avgRiskScore: document.getElementById('avg-risk-score'),
    };

    function getRiskInfo(score) {
        if (score > 40) return { color: 'red', textClass: 'text-rose-400', borderClass: 'border-rose-500', tag: 'High Risk' };
        if (score > 20) return { color: 'yellow', textClass: 'text-amber-500', borderClass: 'border-amber-500', tag: 'Medium Risk' };
        return { color: 'green', textClass: 'text-emerald-400', borderClass: 'border-emerald-500', tag: 'Operational' };
    }

    function createSparkline(history, color) {
        if (!history || history.length < 2) return '';
        const w = 120, h = 40;
        const max = Math.max(...history), min = Math.min(...history);
        const range = max - min === 0 ? 1 : max - min;
        const points = history.map((d, i) => `${(i/(history.length-1))*w},${h-((d-min)/range)*h}`).join(' ');
        const stroke = { red: '#f43f5e', yellow: '#d97706', green: '#22c55e' }[color];
        return `<svg viewBox="0 0 ${w} ${h}" class="w-32 h-10"><polyline fill="none" stroke="${stroke}" stroke-width="2" points="${points}"/></svg>`;
    }

    function renderRoomList() {
        let totalScore = 0, deviceCount = 0;
        
        for (const roomId in hospitalLayout) {
            const room = hospitalLayout[roomId];
            const deviceId = room.devices[0];
            const data = deviceScores[deviceId] || { risk_score: 0 };
            const risk = getRiskInfo(data.risk_score);

            totalScore += data.risk_score;
            deviceCount++;

            let card = document.getElementById(`room-card-${roomId}`);
            if (!card) {
                // Create card if it doesn't exist
                card = document.createElement('div');
                card.id = `room-card-${roomId}`;
                dom.roomList.appendChild(card);
            }

            // Update card content
            card.className = `glass-panel p-4 rounded-xl shadow-lg flex items-center justify-between border-l-8 ${risk.borderClass} transition-colors duration-500`;
            card.innerHTML = `
                <div class="flex-1">
                    <h3 class="text-xl font-bold text-slate-100">${room.name}</h3>
                    <p class="text-sm text-slate-400">${deviceId.replace(/_/g, ' ')}</p>
                </div>
                <div class="w-32 h-10">
                    ${createSparkline(deviceHistory[deviceId], risk.color)}
                </div>
                <div class="text-right w-28 ml-4">
                    <p class="text-4xl font-extrabold text-slate-200">${data.risk_score}</p>
                    <p class="text-xs ${risk.textClass} font-semibold">${risk.tag}</p>
                </div>
            `;
        }
        
        dom.avgRiskScore.textContent = deviceCount > 0 ? (totalScore / deviceCount).toFixed(0) : 0;
    }
    
    async function fetchAllDeviceScores() {
        const promises = Object.entries(allDeviceTypes).map(async ([deviceId, deviceType]) => {
            const normalcyChance = 0.95;
            const isNormal = Math.random() < normalcyChance;
            let payload;
            if (isNormal) {
                payload = { device_id: deviceId, device_type: deviceType, pkt_sec: Math.random() * 20, bytes_sec: Math.random() * 1000, dest_count: Math.floor(Math.random() * 3), avg_payload: Math.random() * 128, patch_status: 'patched', maintenance_days: Math.floor(Math.random() * 90) };
            } else {
                payload = { device_id: deviceId, device_type: deviceType, pkt_sec: Math.random() * 500, bytes_sec: Math.random() * 10000, dest_count: Math.floor(Math.random() * 20), avg_payload: Math.random() * 1024, patch_status: Math.random() > 0.8 ? 'unpatched' : 'patched', maintenance_days: Math.floor(Math.random() * 365) };
            }
            try {
                const res = await fetch(`${API_BASE_URL}/ml/score`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!res.ok) return;
                const data = await res.json();
                
                deviceScores[deviceId] = data;
                
                if (!deviceHistory[deviceId]) deviceHistory[deviceId] = [];
                deviceHistory[deviceId].push(data.risk_score);
                if (deviceHistory[deviceId].length > 20) deviceHistory[deviceId].shift();

            } catch (error) { console.error(`API Error for ${deviceId}:`, error); }
        });
        await Promise.all(promises);
        renderRoomList();
    }
    
    window.addEventListener('load', () => {
        fetchAllDeviceScores();
        setInterval(fetchAllDeviceScores, 2500);
    });
</script>

</body>
</html>

