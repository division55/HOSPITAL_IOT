<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale-1.0">
    <title>Hospital Device Monitoring Map</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* slate-50 */
        }
        .map-room {
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            stroke: #9ca3af; /* gray-400 */
            stroke-width: 1;
        }
        .map-room:hover {
            stroke-width: 2.5;
            stroke: #3b82f6; /* blue-500 */
        }
        .map-room.active {
            stroke-width: 3;
            stroke: #0284c7; /* sky-600 */
        }
        /* Risk-based fill colors */
        .risk-normal { fill: #dcfce7; } /* green-100 */
        .risk-medium { fill: #fef9c3; } /* yellow-100 */
        .risk-high { fill: #fee2e2; } /* red-100 */

        @keyframes pulse-red {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            50% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
        }
        .animate-pulse-red {
            animation: pulse-red 2s infinite;
        }
    </style>
</head>
<body class="text-slate-800">

    <div class="container mx-auto p-4 md:p-6 max-w-7xl">
        <header class="mb-6 border-b border-slate-200 pb-4">
            <h1 class="text-3xl font-bold text-slate-700">Hospital Device Overview</h1>
            <p class="text-slate-500">Live risk assessment via interactive floor plan. Click a room to see device details.</p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-5 gap-6 h-[75vh]">
            <!-- Map Section -->
            <section class="lg:col-span-3 bg-white p-4 rounded-xl shadow-md flex flex-col items-center justify-center border border-slate-200">
                <h2 class="text-xl font-semibold mb-4 text-center text-slate-600">Main Hospital Floor Plan</h2>
                <svg id="hospital-map" viewBox="0 0 400 300" class="w-full h-full">
                    <g id="map-rooms">
                        <rect id="room-icu" class="map-room risk-normal" x="20" y="20" width="150" height="90" rx="5"/>
                        <text x="95" y="70" text-anchor="middle" font-size="14" fill="#334155" pointer-events="none" class="font-semibold">ICU</text>
                        
                        <rect id="room-er" class="map-room risk-normal" x="20" y="120" width="150" height="160" rx="5"/>
                        <text x="95" y="200" text-anchor="middle" font-size="14" fill="#334155" pointer-events="none" class="font-semibold">Emergency Room</text>

                        <rect id="room-or" class="map-room risk-normal" x="180" y="20" width="200" height="90" rx="5"/>
                        <text x="280" y="70" text-anchor="middle" font-size="14" fill="#334155" pointer-events="none" class="font-semibold">Operating Room</text>

                        <rect id="room-ward-a" class="map-room risk-normal" x="180" y="120" width="200" height="80" rx="5"/>
                        <text x="280" y="165" text-anchor="middle" font-size="14" fill="#334155" pointer-events="none" class="font-semibold">Ward A</text>

                        <rect id="room-ward-b" class="map-room risk-normal" x="180" y="210" width="200" height="70" rx="5"/>
                        <text x="280" y="250" text-anchor="middle" font-size="14" fill="#334155" pointer-events="none" class="font-semibold">Ward B</text>
                    </g>
                </svg>
            </section>

            <!-- Device Info Section -->
            <aside class="lg:col-span-2 bg-white p-6 rounded-xl shadow-md flex flex-col border border-slate-200">
                <h2 id="device-panel-title" class="text-xl font-semibold mb-4 border-b border-slate-200 pb-3 text-slate-600">Select a Room</h2>
                <div id="device-list" class="flex-grow overflow-y-auto space-y-3 pr-2">
                   <p class="text-slate-400 text-center mt-10">Device information will appear here once a room is selected.</p>
                </div>
            </aside>
        </main>
    </div>

    <script>
        const API_BASE_URL = 'http://127.0.0.1:9000';

        // --- HOSPITAL LAYOUT & DEVICE CONFIGURATION ---
        const hospitalLayout = {
            "room-icu": { name: "ICU", devices: ["pacemaker_01"] },
            "room-er": { name: "Emergency Room", devices: ["blood_pressure_monitor_01"] },
            "room-or": { name: "Operating Room", devices: ["heart_rate_sensor_02"] },
            "room-ward-a": { name: "Ward A", devices: ["insulin_pump_01"] },
            "room-ward-b": { name: "Ward B", devices: ["glucose_monitor_01"] }
        };

        const allDeviceTypes = {
            "pacemaker_01": "pacemaker",
            "blood_pressure_monitor_01": "blood_pressure_monitor",
            "heart_rate_sensor_02": "heart_rate_sensor",
            "insulin_pump_01": "insulin_pump",
            "glucose_monitor_01": "glucose_monitor"
        };
        
        let deviceScores = {}; // Stores the latest score for each device
        let activeRoomId = null;

        // --- DOM ELEMENTS ---
        const mapRooms = document.getElementById('map-rooms');
        const devicePanelTitle = document.getElementById('device-panel-title');
        const deviceList = document.getElementById('device-list');

        // --- UI RENDERING FUNCTIONS ---
        function getRiskClasses(score) {
            if (score > 75) return { color: 'red', fillClass: 'risk-high', textClass: 'text-red-800', bgClass: 'bg-red-50', tag: 'High Risk' };
            if (score > 40) return { color: 'yellow', fillClass: 'risk-medium', textClass: 'text-amber-800', bgClass: 'bg-amber-50', tag: 'Medium Risk' };
            return { color: 'green', fillClass: 'risk-normal', textClass: 'text-emerald-800', bgClass: 'bg-emerald-50', tag: 'Normal' };
        }

        function updateRoomColors() {
            for (const roomId in hospitalLayout) {
                const room = hospitalLayout[roomId];
                const roomEl = document.getElementById(roomId);
                if (!roomEl) continue;

                let highestRisk = 0;
                room.devices.forEach(deviceId => {
                    const score = deviceScores[deviceId]?.risk_score || 0;
                    if (score > highestRisk) {
                        highestRisk = score;
                    }
                });
                
                const riskInfo = getRiskClasses(highestRisk);
                roomEl.setAttribute('class', `map-room ${riskInfo.fillClass} ${roomId === activeRoomId ? 'active' : ''}`);
            }
        }
        
        function renderDeviceListForActiveRoom() {
            if (!activeRoomId) {
                devicePanelTitle.textContent = 'Select a Room';
                deviceList.innerHTML = '<p class="text-slate-400 text-center mt-10">Device information will appear here.</p>';
                return;
            }

            const room = hospitalLayout[activeRoomId];
            devicePanelTitle.textContent = `Devices in ${room.name}`;
            deviceList.innerHTML = ''; // Clear previous list

            if (room.devices.length === 0) {
                deviceList.innerHTML = '<p class="text-slate-400 text-center mt-10">No devices in this room.</p>';
                return;
            }

            room.devices.forEach(deviceId => {
                const scoreData = deviceScores[deviceId];
                if (!scoreData) return;

                const risk = getRiskClasses(scoreData.risk_score);
                const card = document.createElement('div');
                card.className = `p-3 rounded-lg border-l-4 transition-all duration-300 border-${risk.color}-500 ${risk.bgClass}`;
                card.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="font-bold text-slate-700">${deviceId}</p>
                            <p class="text-xs text-slate-500">${scoreData.reasons.join(', ') || 'Normal operation'}</p>
                        </div>
                        <div class="text-right">
                             <p class="text-2xl font-bold text-slate-700">${scoreData.risk_score}</p>
                             <p class="text-xs ${risk.textClass} font-semibold">${risk.tag}</p>
                        </div>
                    </div>
                `;
                deviceList.appendChild(card);
            });
        }
        
        // --- CORE LOGIC: API INTERACTION ---
        async function fetchAllDeviceScores() {
            const scorePromises = Object.entries(allDeviceTypes).map(async ([deviceId, deviceType]) => {
                // Generate random data for simulation
                const payload = {
                    device_id: deviceId, device_type: deviceType,
                    pkt_sec: parseFloat((Math.random() * 500).toFixed(2)),
                    bytes_sec: parseFloat((Math.random() * 10000).toFixed(2)),
                    dest_count: Math.floor(Math.random() * 20),
                    avg_payload: parseFloat((Math.random() * 1024).toFixed(2)),
                    patch_status: Math.random() > 0.8 ? 'unpatched' : 'patched',
                    maintenance_days: Math.floor(Math.random() * 365)
                };

                try {
                    const response = await fetch(`${API_BASE_URL}/ml/score`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        // If model not found, keep old score or default to 0
                        console.warn(`Could not score ${deviceId}. Model may need training.`);
                        return;
                    }

                    const scoreData = await response.json();
                    deviceScores[deviceId] = scoreData;

                } catch (error) {
                    console.error(`Error fetching score for ${deviceId}:`, error);
                }
            });

            await Promise.all(scorePromises);
            
            // After all scores are fetched, update the UI
            updateRoomColors();
            renderDeviceListForActiveRoom();
        }

        // --- EVENT LISTENERS ---
        mapRooms.addEventListener('click', (e) => {
            const roomEl = e.target.closest('.map-room');
            if (!roomEl) return;
            
            // Manage active state visuals
            document.querySelectorAll('.map-room.active').forEach(el => el.classList.remove('active'));
            roomEl.classList.add('active');
            
            activeRoomId = roomEl.id;
            renderDeviceListForActiveRoom();
        });

        // --- INITIALIZATION ---
        window.addEventListener('load', () => {
            // Initial fetch, then repeat every 3 seconds
            fetchAllDeviceScores();
            setInterval(fetchAllDeviceScores, 3000); 
        });
    </script>
</body>
</html>