<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Hospital Device Monitoring Map</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f8fafc; /* slate-50 */
    }
    .map-room {
      cursor: pointer;
      transition: all 0.25s ease-in-out;
      stroke: #cbd5e1; /* slate-300 */
      stroke-width: 1.5;
      filter: drop-shadow(0 1px 2px rgba(0,0,0,0.05));
    }
    .map-room:hover, .map-room.active {
      stroke-width: 3;
      stroke: #2563eb; /* blue-600 */
      filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1));
    }
    .risk-high-glow {
      animation: glow 1.5s infinite;
    }
    @keyframes glow {
      0%, 100% { filter: drop-shadow(0 0 0 rgba(239,68,68,0.6)); }
      50% { filter: drop-shadow(0 0 12px rgba(239,68,68,0.8)); }
    }
    .device-card {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      border-radius: 0.75rem;
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(6px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .device-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
  </style>
</head>
<body class="text-slate-800">

<div class="container mx-auto p-4 md:p-6 max-w-7xl">
  <header class="mb-6 border-b border-slate-200 pb-4">
    <h1 class="text-4xl font-extrabold text-slate-700 tracking-tight">üè• Hospital Device Overview</h1>
    <p class="text-slate-500 mt-1">Live risk assessment via interactive floor plan. Click a room to see device details.</p>
  </header>

  <main class="grid grid-cols-1 lg:grid-cols-5 gap-6 h-[75vh]">
    <!-- Map Section -->
    <section class="lg:col-span-3 bg-white p-4 rounded-xl shadow-lg flex flex-col items-center justify-center border border-slate-200">
      <h2 class="text-xl font-semibold mb-4 text-center text-slate-600">Main Hospital Floor Plan</h2>
      <svg id="hospital-map" viewBox="0 0 400 300" class="w-full h-full">
        <defs>
          <linearGradient id="grad-green" x1="0" y1="0" x2="1" y2="1">
            <stop offset="0%" stop-color="#bbf7d0"/>
            <stop offset="100%" stop-color="#86efac"/>
          </linearGradient>
          <linearGradient id="grad-yellow" x1="0" y1="0" x2="1" y2="1">
            <stop offset="0%" stop-color="#fef9c3"/>
            <stop offset="100%" stop-color="#fde68a"/>
          </linearGradient>
          <linearGradient id="grad-red" x1="0" y1="0" x2="1" y2="1">
            <stop offset="0%" stop-color="#fecaca"/>
            <stop offset="100%" stop-color="#fca5a5"/>
          </linearGradient>
        </defs>
        <g id="map-rooms">
          <rect id="room-icu" class="map-room" fill="url(#grad-green)" x="20" y="20" width="150" height="90" rx="8"/>
          <text x="95" y="70" text-anchor="middle" font-size="14" fill="#334155" pointer-events="none" class="font-semibold">ICU</text>
          
          <rect id="room-er" class="map-room" fill="url(#grad-green)" x="20" y="120" width="150" height="160" rx="8"/>
          <text x="95" y="200" text-anchor="middle" font-size="14" fill="#334155" pointer-events="none" class="font-semibold">Emergency Room</text>

          <rect id="room-or" class="map-room" fill="url(#grad-green)" x="180" y="20" width="200" height="90" rx="8"/>
          <text x="280" y="70" text-anchor="middle" font-size="14" fill="#334155" pointer-events="none" class="font-semibold">Operating Room</text>

          <rect id="room-ward-a" class="map-room" fill="url(#grad-green)" x="180" y="120" width="200" height="80" rx="8"/>
          <text x="280" y="165" text-anchor="middle" font-size="14" fill="#334155" pointer-events="none" class="font-semibold">Ward A</text>

          <rect id="room-ward-b" class="map-room" fill="url(#grad-green)" x="180" y="210" width="200" height="70" rx="8"/>
          <text x="280" y="250" text-anchor="middle" font-size="14" fill="#334155" pointer-events="none" class="font-semibold">Ward B</text>
        </g>
      </svg>
      <!-- Legend -->
      <div class="flex gap-4 mt-4 text-sm text-slate-600">
        <div class="flex items-center gap-2"><span class="w-4 h-4 rounded-sm" style="background: linear-gradient(to bottom right, #bbf7d0, #86efac)"></span> Normal</div>
        <div class="flex items-center gap-2"><span class="w-4 h-4 rounded-sm" style="background: linear-gradient(to bottom right, #fef9c3, #fde68a)"></span> Medium Risk</div>
        <div class="flex items-center gap-2"><span class="w-4 h-4 rounded-sm" style="background: linear-gradient(to bottom right, #fecaca, #fca5a5)"></span> High Risk</div>
      </div>
    </section>

    <!-- Device Info Section -->
    <aside class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg flex flex-col border border-slate-200">
      <h2 id="device-panel-title" class="text-xl font-semibold mb-4 border-b border-slate-200 pb-3 text-slate-600">Select a Room</h2>
      <div id="device-list" class="flex-grow overflow-y-auto space-y-3 pr-2">
        <p class="text-slate-400 text-center mt-10">Device information will appear here once a room is selected.</p>
      </div>
    </aside>
  </main>
</div>

<script>
    const API_BASE_URL = 'http://127.0.0.1:9000';

    // --- HOSPITAL LAYOUT & DEVICE CONFIGURATION ---
    const hospitalLayout = {
        "room-icu": { name: "ICU", devices: ["pacemaker_01"] },
        "room-er": { name: "Emergency Room", devices: ["blood_pressure_monitor_01"] },
        "room-or": { name: "Operating Room", devices: ["heart_rate_sensor_02"] },
        "room-ward-a": { name: "Ward A", devices: ["insulin_pump_01"] },
        "room-ward-b": { name: "Ward B", devices: ["glucose_monitor_01"] }
    };

    const allDeviceTypes = {
        "pacemaker_01": "pacemaker",
        "blood_pressure_monitor_01": "blood_pressure_monitor",
        "heart_rate_sensor_02": "heart_rate_sensor",
        "insulin_pump_01": "insulin_pump",
        "glucose_monitor_01": "glucose_monitor"
    };
    
    let deviceScores = {}; // Stores the latest score for each device
    let activeRoomId = null;

    // --- DOM ELEMENTS ---
    const mapRooms = document.getElementById('map-rooms');
    const devicePanelTitle = document.getElementById('device-panel-title');
    const deviceList = document.getElementById('device-list');

    // --- UI RENDERING FUNCTIONS ---
    function getRiskInfo(score) {
        // *** THIS IS THE CHANGED LOGIC ***
        if (score > 40) return { color: 'red', fill: 'url(#grad-red)', textClass: 'text-red-800', bgClass: 'bg-red-50', tag: 'High Risk' };
        if (score > 20) return { color: 'yellow', fill: 'url(#grad-yellow)', textClass: 'text-amber-800', bgClass: 'bg-amber-50', tag: 'Medium Risk' };
        return { color: 'green', fill: 'url(#grad-green)', textClass: 'text-emerald-800', bgClass: 'bg-emerald-50', tag: 'Normal' };
    }

    function updateRoomColors() {
        for (const roomId in hospitalLayout) {
            const room = hospitalLayout[roomId];
            const roomEl = document.getElementById(roomId);
            if (!roomEl) continue;

            let highestRisk = 0;
            room.devices.forEach(deviceId => {
                const score = deviceScores[deviceId]?.risk_score || 0;
                if (score > highestRisk) {
                    highestRisk = score;
                }
            });
            
            const riskInfo = getRiskInfo(highestRisk);
            roomEl.setAttribute('fill', riskInfo.fill);
            if(riskInfo.color === 'red') {
                roomEl.classList.add('risk-high-glow');
            } else {
                roomEl.classList.remove('risk-high-glow');
            }
        }
    }
    
    function renderDeviceListForActiveRoom() {
        if (!activeRoomId) {
            devicePanelTitle.textContent = 'Select a Room';
            deviceList.innerHTML = '<p class="text-slate-400 text-center mt-10">Device information will appear here.</p>';
            return;
        }

        const room = hospitalLayout[activeRoomId];
        devicePanelTitle.textContent = `Devices in ${room.name}`;
        deviceList.innerHTML = '';

        if (room.devices.length === 0) {
            deviceList.innerHTML = '<p class="text-slate-400 text-center mt-10">No devices in this room.</p>';
            return;
        }

        room.devices.forEach(deviceId => {
            const scoreData = deviceScores[deviceId];
            if (!scoreData) return;

            const risk = getRiskInfo(scoreData.risk_score);
            const card = document.createElement('div');
            card.className = `device-card border-l-4 border-${risk.color}-500`;
            card.innerHTML = `
                <div>
                    <p class="font-bold text-slate-700">${deviceId.replace(/_/g, ' ').replace(/(^\w{1})|(\s+\w{1})/g, letter => letter.toUpperCase())}</p>
                    <p class="text-xs text-slate-500">${scoreData.reasons.join(', ') || 'Normal operation'}</p>
                </div>
                <div class="text-right">
                     <p class="text-3xl font-bold text-slate-700">${scoreData.risk_score}</p>
                     <p class="text-xs ${risk.textClass} font-semibold">${risk.tag}</p>
                </div>
            `;
            deviceList.appendChild(card);
        });
    }
    
    // --- CORE LOGIC: API INTERACTION ---
    async function fetchAllDeviceScores() {
        const scorePromises = Object.entries(allDeviceTypes).map(async ([deviceId, deviceType]) => {
            const payload = {
                device_id: deviceId, device_type: deviceType,
                pkt_sec: parseFloat((Math.random() * 500).toFixed(2)),
                bytes_sec: parseFloat((Math.random() * 10000).toFixed(2)),
                dest_count: Math.floor(Math.random() * 20),
                avg_payload: parseFloat((Math.random() * 1024).toFixed(2)),
                patch_status: Math.random() > 0.8 ? 'unpatched' : 'patched',
                maintenance_days: Math.floor(Math.random() * 365)
            };

            try {
                const response = await fetch(`${API_BASE_URL}/ml/score`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    console.warn(`Could not score ${deviceId}. Model may need training.`);
                    return;
                }
                const scoreData = await response.json();
                deviceScores[deviceId] = scoreData;
            } catch (error) {
                console.error(`Error fetching score for ${deviceId}:`, error);
            }
        });

        await Promise.all(scorePromises);
        
        updateRoomColors();
        renderDeviceListForActiveRoom();
    }

    // --- EVENT LISTENERS ---
    mapRooms.addEventListener('click', (e) => {
        const roomEl = e.target.closest('.map-room');
        if (!roomEl) return;
        
        document.querySelectorAll('.map-room.active').forEach(el => el.classList.remove('active'));
        roomEl.classList.add('active');
        
        activeRoomId = roomEl.id;
        renderDeviceListForActiveRoom();
    });

    // --- INITIALIZATION ---
    window.addEventListener('load', () => {
        fetchAllDeviceScores();
        setInterval(fetchAllDeviceScores, 2500); 
    });
</script>
</body>
</html>

